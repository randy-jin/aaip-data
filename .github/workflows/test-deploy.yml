name: Test Branch CI/CD

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Python dependencies
      run: |
        cd scraper
        pip install -r requirements.txt
        cd ../backend
        pip install -r requirements.txt
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --ignore-scripts --ignore-scripts
        
    - name: Test scraper
      env:
        DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      run: |
        cd scraper
        python3 -c "import scraper_enhanced; print('Scraper module loaded successfully')"
        
    - name: Test backend
      run: |
        cd backend
        python3 -c "import main_enhanced; print('Backend module loaded successfully')"
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Test frontend build
      run: |
        cd frontend
        test -d dist && echo "Frontend build successful"
        
  # Job 2: Deploy to Test Server via Cloudflare Tunnel
  deploy:
    name: Deploy to Test Server
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/test'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ’¾ Cache cloudflared CLI
      id: cache-cloudflared
      uses: actions/cache@v3
      with:
        path: /usr/local/bin/cloudflared
        key: cloudflared-${{ runner.os }}-latest
        
    - name: ğŸ› ï¸ Install cloudflared CLI
      if: steps.cache-cloudflared.outputs.cache-hit != 'true'
      run: |
        echo "ğŸ“¥ Downloading cloudflared (cache miss)..."
        curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared.deb
        rm cloudflared.deb
        echo "âœ… cloudflared installed"
        
    - name: âœ… Using cached cloudflared
      if: steps.cache-cloudflared.outputs.cache-hit == 'true'
      run: |
        echo "ğŸ¯ Using cached cloudflared CLI"
        cloudflared --version

    - name: ğŸ”‘ Setup SSH and Cloudflare Tunnel
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SSH_USER: ${{ secrets.SSH_USER }}
        CF_SSH_HOSTNAME: ${{ secrets.CF_SSH_HOSTNAME }}
        CF_SERVICE_TOKEN_ID: ${{ secrets.CF_SERVICE_TOKEN_ID }}
        CF_SERVICE_TOKEN_SECRET: ${{ secrets.CF_SERVICE_TOKEN_SECRET }}
      run: |
        echo "--- Setting up SSH key and Cloudflare Tunnel config ---"
        mkdir -p ~/.ssh
        
        # Setup SSH private key
        echo "${SSH_PRIVATE_KEY}" > ~/.ssh/github_actions_key
        chmod 600 ~/.ssh/github_actions_key

        # Create a wrapper script for cloudflared to inject service token
        mkdir -p /home/runner/bin
        cat > /home/runner/bin/cf-ssh << EOF
        #!/bin/bash
        export CLOUDFLARED_SERVICE_TOKEN_ID=${CF_SERVICE_TOKEN_ID}
        export CLOUDFLARED_SERVICE_TOKEN_SECRET=${CF_SERVICE_TOKEN_SECRET}
        exec /usr/local/bin/cloudflared access ssh --hostname \$1
        EOF
        chmod +x /home/runner/bin/cf-ssh

        # Create a comprehensive SSH config for the tunnel
        cat > ~/.ssh/config << EOF
        Host deploy-server
            HostName ${CF_SSH_HOSTNAME}
            User ${SSH_USER}
            IdentityFile ~/.ssh/github_actions_key
            ProxyCommand /home/runner/bin/cf-ssh %h
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config
        
        echo "âœ… SSH and Cloudflare Tunnel configured."
        echo "SSH Config:"
        cat ~/.ssh/config

    - name: ğŸ”— Test SSH Connection
      run: |
        echo "--- Testing SSH connection via Cloudflare Tunnel ---"
        ssh -v deploy-server "echo 'SSH connection successful'"

    - name: ğŸš€ Deploy Backend
      env:
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        echo "--- Deploying Backend via SSH ---"
        ssh deploy-server << 'ENDSSH'
          set -e
          cd ${{ secrets.TEST_DEPLOY_PATH }}

          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git checkout test
          git pull origin test

          echo "ğŸ”§ Updating backend..."
          cd backend
          pip3 install -r requirements.txt --quiet

          echo "â™»ï¸ Restarting backend service..."
          sudo systemctl restart aaip-backend-test || echo "âš ï¸ Manual restart required"

          echo "âœ… Backend deployment complete"
        ENDSSH
        
    - name: ğŸ¨ Deploy Frontend
      env:
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        echo "--- Deploying Frontend via SSH ---"
        ssh deploy-server << 'ENDSSH'
          set -e
          cd ${{ secrets.TEST_DEPLOY_PATH }}/frontend

          echo "ğŸ“¦ Installing frontend dependencies..."
          npm ci --quiet

          echo "ğŸ—ï¸ Building frontend..."
          npm run build

          echo "ğŸ“¤ Deploying to web server..."
          sudo cp -r dist/* /var/www/aaip-test/ || echo "âš ï¸ Manual copy required"

          echo "âœ… Frontend deployment complete"
        ENDSSH
        
    - name: ğŸ”„ Update Scraper
      env:
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        echo "--- Updating Scraper via SSH ---"
        ssh deploy-server << 'ENDSSH'
          set -e
          cd ${{ secrets.TEST_DEPLOY_PATH }}/scraper

          echo "ğŸ”§ Updating scraper dependencies..."
          pip3 install -r requirements.txt --quiet

          echo "âœ… Scraper update complete"
        ENDSSH
        
    - name: ğŸ’š Health Check
      env:
        TEST_BACKEND_URL: ${{ secrets.TEST_BACKEND_URL }}
        TEST_FRONTEND_URL: ${{ secrets.TEST_FRONTEND_URL }}
      run: |
        echo "â³ Waiting for services to start..."
        sleep 15
        
        echo "ğŸ” Checking backend health..."
        # ... (Health Check é€»è¾‘ä¸å˜)
        if curl -f -s ${TEST_BACKEND_URL} > /dev/null; then
          echo "âœ… Backend is healthy"
        else
          echo "âŒ Backend health check failed"
          exit 1
        fi
        
        echo "ğŸ” Checking frontend..."
        if curl -f -s ${TEST_FRONTEND_URL} > /dev/null; then
          echo "âœ… Frontend is accessible"
        else
          echo "âŒ Frontend health check failed"
          exit 1
        fi
        
        echo "âœ¨ All health checks passed!"
        
    - name: ğŸ“Š Deployment Summary
      if: success()
      run: |
        echo "ğŸ‰ Deployment to test server successful!"
        echo ""
        echo "ğŸ“ Endpoints:"
        echo "   Backend: ${{ secrets.TEST_BACKEND_URL }}"
        echo "   Frontend: ${{ secrets.TEST_FRONTEND_URL }}"
        echo ""
        echo "ğŸ• Deployed at: $(date -u)"
        
    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "ğŸ’¥ Deployment failed - check logs above"
        echo "ğŸ”§ You may need to deploy manually"
