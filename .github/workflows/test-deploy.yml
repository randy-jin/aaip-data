name: Test Branch CI/CD

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Python dependencies
      run: |
        cd scraper
        pip install -r requirements.txt
        cd ../backend
        pip install -r requirements.txt
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --ignore-scripts --ignore-scripts
        
    - name: Test scraper
      env:
        DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      run: |
        cd scraper
        python3 -c "import scraper_enhanced; print('Scraper module loaded successfully')"
        
    - name: Test backend
      run: |
        cd backend
        python3 -c "import main_enhanced; print('Backend module loaded successfully')"
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Test frontend build
      run: |
        cd frontend
        test -d dist && echo "Frontend build successful"
        
  # Job 2: Deploy to Test Server via Cloudflare Tunnel
  deploy:
    name: Deploy to Test Server
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/test'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ’¾ Cache cloudflared CLI
      id: cache-cloudflared
      uses: actions/cache@v3
      with:
        path: /usr/local/bin/cloudflared
        key: cloudflared-${{ runner.os }}-latest
        
    - name: ğŸ› ï¸ Install cloudflared CLI
      if: steps.cache-cloudflared.outputs.cache-hit != 'true'
      run: |
        echo "ğŸ“¥ Downloading cloudflared (cache miss)..."
        curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared.deb
        rm cloudflared.deb
        echo "âœ… cloudflared installed"
        
    - name: âœ… Using cached cloudflared
      if: steps.cache-cloudflared.outputs.cache-hit == 'true'
      run: |
        echo "ğŸ¯ Using cached cloudflared CLI"
        cloudflared --version
        
    # ** ç§»é™¤åŸæ¥çš„ 'ğŸ”‘ Setup Cloudflare Tunnel Credentials' æ­¥éª¤ **
    # ** ç§»é™¤åŸæ¥çš„ 'ğŸ”§ Configure SSH for Cloudflare Tunnel' æ­¥éª¤ **
        
    - name: ğŸš€ Deploy Backend via Cloudflare Tunnel
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        CF_SSH_HOSTNAME: ${{ secrets.CF_SSH_HOSTNAME }} # ssh.randy.it.com
        CF_SERVICE_CLIENT_ID: ${{ secrets.CF_SERVICE_CLIENT_ID }}
        CF_SERVICE_CLIENT_SECRET: ${{ secrets.CF_SERVICE_CLIENT_SECRET }}
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        echo "--- Preparing Service Token for cloudflared ---"
        # åˆ›å»º Service Token JSON æ–‡ä»¶ï¼Œç”¨äº cloudflared access ssh è®¤è¯
        TOKEN_FILE="/tmp/cf_service_token.json"
        cat > ${TOKEN_FILE} << EOF
        {
          "Client ID": "${{ secrets.CF_SERVICE_CLIENT_ID }}",
          "Client Secret": "${{ secrets.CF_SERVICE_CLIENT_SECRET }}"
        }
        EOF
        
        echo "--- Starting Backend Deployment via cloudflared access ssh ---"
        # ä½¿ç”¨ cloudflared access ssh è¿æ¥ï¼Œå¹¶ä¼ é€’ Service Token
        /usr/local/bin/cloudflared access ssh \
          --hostname ${CF_SSH_HOSTNAME} \
          --identity-file ${TOKEN_FILE} \
          -- ${SSH_USER} << 'ENDSSH'
          
          set -e
          cd '${{ secrets.TEST_DEPLOY_PATH }}'

          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git checkout test
          git pull origin test

          echo "ğŸ”§ Updating backend..."
          cd backend
          pip3 install -r requirements.txt --quiet

          echo "â™»ï¸ Restarting backend service..."
          sudo systemctl restart aaip-backend-test || echo "âš ï¸ Manual restart required"

          echo "âœ… Backend deployment complete"
        ENDSSH
        
        rm ${TOKEN_FILE}
        
    - name: ğŸ¨ Deploy Frontend via Cloudflare Tunnel
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        CF_SSH_HOSTNAME: ${{ secrets.CF_SSH_HOSTNAME }}
        CF_SERVICE_CLIENT_ID: ${{ secrets.CF_SERVICE_CLIENT_ID }}
        CF_SERVICE_CLIENT_SECRET: ${{ secrets.CF_SERVICE_CLIENT_SECRET }}
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        TOKEN_FILE="/tmp/cf_service_token.json"
        cat > ${TOKEN_FILE} << EOF
        {
          "Client ID": "${{ secrets.CF_SERVICE_CLIENT_ID }}",
          "Client Secret": "${{ secrets.CF_SERVICE_CLIENT_SECRET }}"
        }
        EOF

        /usr/local/bin/cloudflared access ssh \
          --hostname ${CF_SSH_HOSTNAME} \
          --identity-file ${TOKEN_FILE} \
          -- ${SSH_USER} << 'ENDSSH'
          
          set -e
          cd '${{ secrets.TEST_DEPLOY_PATH }}/frontend'
          
          echo "ğŸ“¦ Installing frontend dependencies..."
          npm ci --quiet
          
          echo "ğŸ—ï¸ Building frontend..."
          npm run build
          
          echo "ğŸ“¤ Deploying to web server..."
          # ä½¿ç”¨ DEPLOY_PATH å˜é‡ç¡®ä¿è·¯å¾„æ­£ç¡®
          sudo cp -r dist/* /var/www/aaip-test/ || echo "âš ï¸ Manual copy required"
          
          echo "âœ… Frontend deployment complete"
        ENDSSH
        
        rm ${TOKEN_FILE}
        
    - name: ğŸ”„ Update Scraper via Cloudflare Tunnel
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        CF_SSH_HOSTNAME: ${{ secrets.CF_SSH_HOSTNAME }}
        CF_SERVICE_CLIENT_ID: ${{ secrets.CF_SERVICE_CLIENT_ID }}
        CF_SERVICE_CLIENT_SECRET: ${{ secrets.CF_SERVICE_CLIENT_SECRET }}
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        TOKEN_FILE="/tmp/cf_service_token.json"
        cat > ${TOKEN_FILE} << EOF
        {
          "Client ID": "${{ secrets.CF_SERVICE_CLIENT_ID }}",
          "Client Secret": "${{ secrets.CF_SERVICE_CLIENT_SECRET }}"
        }
        EOF

        /usr/local/bin/cloudflared access ssh \
          --hostname ${CF_SSH_HOSTNAME} \
          --identity-file ${TOKEN_FILE} \
          -- ${SSH_USER} << 'ENDSSH'
          
          set -e
          cd '${{ secrets.TEST_DEPLOY_PATH }}/scraper'
          
          echo "ğŸ”§ Updating scraper dependencies..."
          pip3 install -r requirements.txt --quiet
          
          echo "âœ… Scraper update complete"
        ENDSSH
        
        rm ${TOKEN_FILE}
        
    - name: ğŸ’š Health Check
      env:
        TEST_BACKEND_URL: ${{ secrets.TEST_BACKEND_URL }}
        TEST_FRONTEND_URL: ${{ secrets.TEST_FRONTEND_URL }}
      run: |
        echo "â³ Waiting for services to start..."
        sleep 15
        
        echo "ğŸ” Checking backend health..."
        # ... (Health Check é€»è¾‘ä¸å˜)
        if curl -f -s ${TEST_BACKEND_URL} > /dev/null; then
          echo "âœ… Backend is healthy"
        else
          echo "âŒ Backend health check failed"
          exit 1
        fi
        
        echo "ğŸ” Checking frontend..."
        if curl -f -s ${TEST_FRONTEND_URL} > /dev/null; then
          echo "âœ… Frontend is accessible"
        else
          echo "âŒ Frontend health check failed"
          exit 1
        fi
        
        echo "âœ¨ All health checks passed!"
        
    - name: ğŸ“Š Deployment Summary
      if: success()
      run: |
        echo "ğŸ‰ Deployment to test server successful!"
        echo ""
        echo "ğŸ“ Endpoints:"
        echo "   Backend: ${{ secrets.TEST_BACKEND_URL }}"
        echo "   Frontend: ${{ secrets.TEST_FRONTEND_URL }}"
        echo ""
        echo "ğŸ• Deployed at: $(date -u)"
        
    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "ğŸ’¥ Deployment failed - check logs above"
        echo "ğŸ”§ You may need to deploy manually"
