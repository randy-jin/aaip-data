name: Test Branch CI/CD

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Python dependencies
      run: |
        cd scraper
        pip install -r requirements.txt
        cd ../backend
        pip install -r requirements.txt
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --ignore-scripts --ignore-scripts
        
    - name: Test scraper
      env:
        DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      run: |
        cd scraper
        python3 -c "import scraper_enhanced; print('Scraper module loaded successfully')"
        
    - name: Test backend
      run: |
        cd backend
        python3 -c "import main_enhanced; print('Backend module loaded successfully')"
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Test frontend build
      run: |
        cd frontend
        test -d dist && echo "Frontend build successful"
        
  # Job 2: Deploy to Test Server via Cloudflare Tunnel
  deploy:
    name: Deploy to Test Server
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/test'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to Server via Cloudflare Tunnel
      uses: cloudflare/cloudflared-ssh-action@v1
      with:
        host: ${{ secrets.CF_SSH_HOSTNAME }}
        username: ${{ secrets.SSH_USER }}
        privateKey: ${{ secrets.SSH_PRIVATE_KEY }}
        # serviceTokenId: ${{ secrets.CF_SERVICE_CLIENT_ID }}     # å¦‚æœæ²¡æœ‰é…ç½® Cloudflare Accessï¼Œä¸éœ€è¦è¿™ä¸¤è¡Œ
        # serviceTokenSecret: ${{ secrets.CF_SERVICE_CLIENT_SECRET }}
        commands: |
          set -e
          cd ${{ secrets.TEST_DEPLOY_PATH }}

          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git checkout test
          git pull origin test

          echo "ğŸ”§ Updating backend..."
          cd backend
          pip3 install -r requirements.txt --quiet
          
          echo "â™»ï¸ Restarting backend service..."
          sudo systemctl restart aaip-backend-test

          echo "ğŸ“¦ Installing frontend dependencies..."
          cd ../frontend
          npm ci --quiet

          echo "ğŸ—ï¸ Building frontend..."
          npm run build

          echo "ğŸ“¤ Deploying to web server..."
          sudo cp -r dist/* /var/www/aaip-test/

          echo "ğŸ”§ Updating scraper dependencies..."
          cd ../scraper
          pip3 install -r requirements.txt --quiet

          echo "âœ… Deployment complete"
