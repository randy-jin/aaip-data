name: Test Branch CI/CD

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Python dependencies
      run: |
        cd scraper
        pip install -r requirements.txt
        cd ../backend
        pip install -r requirements.txt
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --ignore-scripts --ignore-scripts
        
    - name: Test scraper
      env:
        DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      run: |
        cd scraper
        python3 -c "import scraper_enhanced; print('Scraper module loaded successfully')"
        
    - name: Test backend
      run: |
        cd backend
        python3 -c "import main_enhanced; print('Backend module loaded successfully')"
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Test frontend build
      run: |
        cd frontend
        test -d dist && echo "Frontend build successful"
        
  # Job 2: Deploy to Test Server via Cloudflare Tunnel
  deploy:
    name: Deploy to Test Server
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/test'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: üíæ Cache cloudflared CLI
      id: cache-cloudflared
      uses: actions/cache@v3
      with:
        path: /usr/local/bin/cloudflared
        key: cloudflared-${{ runner.os }}-latest
        
    - name: üõ†Ô∏è Install cloudflared CLI
      if: steps.cache-cloudflared.outputs.cache-hit != 'true'
      run: |
        echo "üì• Downloading cloudflared (cache miss)..."
        curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared.deb
        rm cloudflared.deb
        echo "‚úÖ cloudflared installed"
        
    - name: ‚úÖ Using cached cloudflared
      if: steps.cache-cloudflared.outputs.cache-hit == 'true'
      run: |
        echo "üéØ Using cached cloudflared CLI"
        cloudflared --version

    - name: üîë Setup SSH Key
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        echo "Setting up SSH key for authentication..."
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/github_actions_key
        chmod 600 ~/.ssh/github_actions_key

        # Verify SSH key was written correctly
        echo "SSH key first line:"
        head -1 ~/.ssh/github_actions_key
        echo "SSH key length: $(wc -l < ~/.ssh/github_actions_key) lines"

        # Add SSH config
        cat >> ~/.ssh/config << 'EOF'
        Host localhost
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            IdentityFile ~/.ssh/github_actions_key
            PubkeyAuthentication yes
            PasswordAuthentication no
        EOF
        chmod 600 ~/.ssh/config

        echo "SSH config created:"
        cat ~/.ssh/config

    - name: üöÄ Deploy Backend via Cloudflare Tunnel
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        CF_SSH_HOSTNAME: ${{ secrets.CF_SSH_HOSTNAME }} # ssh.randy.it.com
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        echo "--- Testing Cloudflare Tunnel connectivity ---"
        # Test DNS resolution
        nslookup ${CF_SSH_HOSTNAME} || echo "DNS lookup failed"

        echo "--- Starting Cloudflare Tunnel TCP proxy ---"
        # Start TCP proxy in background with verbose logging
        /usr/local/bin/cloudflared access tcp --hostname ${CF_SSH_HOSTNAME} --url tcp://localhost:2222 > /tmp/cf-proxy.log 2>&1 &
        PROXY_PID=$!
        echo "Proxy PID: $PROXY_PID"

        # Wait for proxy to be ready with retries
        echo "Waiting for proxy to start..."
        for i in {1..30}; do
          if netstat -tln | grep -q 2222; then
            echo "‚úÖ Port 2222 is listening"
            break
          fi
          echo "Waiting for port 2222... ($i/30)"
          sleep 1
        done

        # Check if proxy is listening
        netstat -tln | grep 2222 || {
          echo "‚ùå Error: Port 2222 not listening after 30 seconds"
          cat /tmp/cf-proxy.log
          exit 1
        }

        # Wait additional time for tunnel to stabilize
        echo "Waiting for tunnel to stabilize..."
        sleep 5

        # Show proxy logs
        echo "Proxy logs:"
        cat /tmp/cf-proxy.log || true

        echo "--- Testing SSH connection ---"
        # Test SSH connection with verbose output
        ssh -p 2222 -v -o ConnectTimeout=30 ${SSH_USER}@localhost "echo 'SSH connection successful'" 2>&1 | tail -20 || {
          echo "SSH connection failed, showing last attempts..."
          exit 1
        }

        echo "--- Deploying Backend via SSH ---"
        ssh -p 2222 \
          -o ConnectTimeout=30 \
          -o ServerAliveInterval=10 \
          ${SSH_USER}@localhost << 'ENDSSH'

          set -e
          cd ${{ secrets.TEST_DEPLOY_PATH }}

          echo "üì• Pulling latest code..."
          git fetch origin
          git checkout test
          git pull origin test

          echo "üîß Updating backend..."
          cd backend
          pip3 install -r requirements.txt --quiet

          echo "‚ôªÔ∏è Restarting backend service..."
          sudo systemctl restart aaip-backend-test || echo "‚ö†Ô∏è Manual restart required"

          echo "‚úÖ Backend deployment complete"
        ENDSSH

        echo "--- Cleaning up proxy ---"
        kill $PROXY_PID || true
        
    - name: üé® Deploy Frontend via Cloudflare Tunnel
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        CF_SSH_HOSTNAME: ${{ secrets.CF_SSH_HOSTNAME }}
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        echo "--- Starting Cloudflare Tunnel TCP proxy ---"
        /usr/local/bin/cloudflared access tcp --hostname ${CF_SSH_HOSTNAME} --url tcp://localhost:2222 > /tmp/cf-proxy-fe.log 2>&1 &
        PROXY_PID=$!

        # Wait for proxy with retries
        for i in {1..30}; do
          if netstat -tln | grep -q 2222; then
            echo "‚úÖ Port 2222 ready"
            break
          fi
          sleep 1
        done
        sleep 5

        echo "--- Deploying Frontend via SSH ---"
        ssh -p 2222 \
          -o ConnectTimeout=30 \
          ${SSH_USER}@localhost << 'ENDSSH'

          set -e
          cd ${{ secrets.TEST_DEPLOY_PATH }}/frontend

          echo "üì¶ Installing frontend dependencies..."
          npm ci --quiet

          echo "üèóÔ∏è Building frontend..."
          npm run build

          echo "üì§ Deploying to web server..."
          sudo cp -r dist/* /var/www/aaip-test/ || echo "‚ö†Ô∏è Manual copy required"

          echo "‚úÖ Frontend deployment complete"
        ENDSSH

        kill $PROXY_PID || true
        
    - name: üîÑ Update Scraper via Cloudflare Tunnel
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        CF_SSH_HOSTNAME: ${{ secrets.CF_SSH_HOSTNAME }}
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        echo "--- Starting Cloudflare Tunnel TCP proxy ---"
        /usr/local/bin/cloudflared access tcp --hostname ${CF_SSH_HOSTNAME} --url tcp://localhost:2222 > /tmp/cf-proxy-sc.log 2>&1 &
        PROXY_PID=$!

        # Wait for proxy with retries
        for i in {1..30}; do
          if netstat -tln | grep -q 2222; then
            echo "‚úÖ Port 2222 ready"
            break
          fi
          sleep 1
        done
        sleep 5

        echo "--- Updating Scraper via SSH ---"
        ssh -p 2222 \
          -o ConnectTimeout=30 \
          ${SSH_USER}@localhost << 'ENDSSH'

          set -e
          cd ${{ secrets.TEST_DEPLOY_PATH }}/scraper

          echo "üîß Updating scraper dependencies..."
          pip3 install -r requirements.txt --quiet

          echo "‚úÖ Scraper update complete"
        ENDSSH

        kill $PROXY_PID || true
        
    - name: üíö Health Check
      env:
        TEST_BACKEND_URL: ${{ secrets.TEST_BACKEND_URL }}
        TEST_FRONTEND_URL: ${{ secrets.TEST_FRONTEND_URL }}
      run: |
        echo "‚è≥ Waiting for services to start..."
        sleep 15
        
        echo "üîç Checking backend health..."
        # ... (Health Check ÈÄªËæë‰∏çÂèò)
        if curl -f -s ${TEST_BACKEND_URL} > /dev/null; then
          echo "‚úÖ Backend is healthy"
        else
          echo "‚ùå Backend health check failed"
          exit 1
        fi
        
        echo "üîç Checking frontend..."
        if curl -f -s ${TEST_FRONTEND_URL} > /dev/null; then
          echo "‚úÖ Frontend is accessible"
        else
          echo "‚ùå Frontend health check failed"
          exit 1
        fi
        
        echo "‚ú® All health checks passed!"
        
    - name: üìä Deployment Summary
      if: success()
      run: |
        echo "üéâ Deployment to test server successful!"
        echo ""
        echo "üìç Endpoints:"
        echo "   Backend: ${{ secrets.TEST_BACKEND_URL }}"
        echo "   Frontend: ${{ secrets.TEST_FRONTEND_URL }}"
        echo ""
        echo "üïê Deployed at: $(date -u)"
        
    - name: ‚ùå Deployment Failed
      if: failure()
      run: |
        echo "üí• Deployment failed - check logs above"
        echo "üîß You may need to deploy manually"
