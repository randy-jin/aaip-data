name: Test Branch CI/CD

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Python dependencies
      run: |
        cd scraper
        pip install -r requirements.txt
        cd ../backend
        pip install -r requirements.txt
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Test scraper
      env:
        DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      run: |
        cd scraper
        python3 -c "import scraper_enhanced; print('Scraper module loaded successfully')"
        
    - name: Test backend
      run: |
        cd backend
        python3 -c "import main_enhanced; print('Backend module loaded successfully')"
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Test frontend build
      run: |
        cd frontend
        test -d dist && echo "Frontend build successful"
        
  # Job 2: Deploy to Test Server via Cloudflare Tunnel
  deploy:
    name: Deploy to Test Server
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/test'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: ðŸ’¾ Cache cloudflared binary
      id: cache-cloudflared
      uses: actions/cache@v3
      with:
        path: ~/cloudflared
        key: cloudflared-${{ runner.os }}-latest

    - name: ðŸ› ï¸ Install cloudflared CLI
      run: |
        if [ -f ~/cloudflared ]; then
          echo "ðŸŽ¯ Using cached cloudflared binary"
          sudo cp ~/cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
        else
          echo "ðŸ“¥ Downloading cloudflared (cache miss)..."
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          rm cloudflared.deb
          # Copy to cache location
          sudo cp /usr/bin/cloudflared ~/cloudflared || sudo cp /usr/local/bin/cloudflared ~/cloudflared
          echo "âœ… cloudflared installed and cached"
        fi
        cloudflared --version

    - name: ðŸ”‘ Setup SSH Key
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

    - name: ðŸš€ Deploy via Cloudflare Tunnel
      env:
        # ä¸´æ—¶æ³¨é‡ŠæŽ‰ Access tokens æµ‹è¯•åŸºæœ¬è¿žæŽ¥
        # CF_ACCESS_CLIENT_ID: ${{ secrets.CF_SERVICE_CLIENT_ID }}
        # CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_SERVICE_CLIENT_SECRET }}
        SSH_USER: ${{ secrets.SSH_USER }}
        CF_SSH_HOSTNAME: ${{ secrets.CF_SSH_HOSTNAME }}
        DEPLOY_PATH: ${{ secrets.TEST_DEPLOY_PATH }}
      run: |
        # Configure SSH to use cloudflared as ProxyCommand
        cat >> ~/.ssh/config << 'EOF'
        Host cf-tunnel
            HostName ${{ secrets.CF_SSH_HOSTNAME }}
            User ${{ secrets.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            ProxyCommand cloudflared access ssh --hostname %h
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
        EOF

        echo "ðŸ”— Connecting to server via Cloudflare Tunnel..."
        ssh cf-tunnel << 'ENDSSH'
          set -e

          # Check if deploy path exists
          if [ ! -d "/home/randy/deploy/aaip-data" ]; then
            echo "âš ï¸ Deploy path does not exist, creating..."
            mkdir -p /home/randy/deploy
            cd /home/randy/deploy
            # Clone with specific branch
            git clone -b test https://github.com/${{ github.repository }}.git aaip-data
          fi

          cd /home/randy/deploy/aaip-data

          # Verify it's a git repository
          if [ ! -d ".git" ]; then
            echo "âŒ Not a git repository!"
            exit 1
          fi

          echo "ðŸ“¥ Pulling latest code from test branch..."
          git fetch origin test
          git checkout test
          git reset --hard origin/test

          echo "ðŸ”§ Updating backend..."
          cd backend

          # Create/activate virtual environment
          if [ ! -d "venv" ]; then
            echo "Creating virtual environment..."
            python3 -m venv venv
          fi
          source venv/bin/activate

          pip install -r requirements.txt --quiet
          deactivate

          echo "â™»ï¸ Restarting backend service..."
          sudo systemctl restart aaip-backend-test

          echo "ðŸ“¦ Installing frontend dependencies..."
          cd ../frontend
          rm -rf node_modules package-lock.json
          npm install --prefer-offline

          echo "ðŸ—ï¸ Building frontend..."
          VITE_API_URL=http://aaip-backend.randy-jt.com npm run build

          echo "ðŸ“¤ Deploying to web server..."
          sudo cp -r dist/* /var/www/aaip-test/

          echo "ðŸ”§ Updating scraper dependencies..."
          cd ../scraper

          # Create/activate virtual environment
          if [ ! -d "venv" ]; then
            echo "Creating virtual environment..."
            python3 -m venv venv
          fi
          source venv/bin/activate

          pip install -r requirements.txt --quiet
          deactivate

          echo "âœ… Deployment complete"
        ENDSSH
